# source /Users/tnappy/node_projects/quickstart/python/bin/activate
# Read env vars from .env file
from plaid.exceptions import ApiException
from plaid.model.products import Products
from plaid.model.country_code import CountryCode
from plaid.model.item_public_token_exchange_request import (
    ItemPublicTokenExchangeRequest,
)
from plaid.model.link_token_create_request import LinkTokenCreateRequest
from plaid.model.link_token_create_request_user import LinkTokenCreateRequestUser
from plaid.model.transactions_get_request import TransactionsGetRequest
from plaid.model.transactions_get_request_options import TransactionsGetRequestOptions
from plaid.model.accounts_get_request import AccountsGetRequest
from plaid.model.transfer_authorization_create_request import (
    TransferAuthorizationCreateRequest,
)
from plaid.model.transfer_create_request import TransferCreateRequest
from plaid.model.transfer_network import TransferNetwork
from plaid.model.transfer_type import TransferType
from plaid.model.transfer_user_in_request import TransferUserInRequest
from plaid.model.ach_class import ACHClass
from plaid.model.transfer_create_idempotency_key import TransferCreateIdempotencyKey
from plaid.model.transfer_user_address_in_request import TransferUserAddressInRequest
from plaid.api import plaid_api
from fastapi import APIRouter, Depends
from fastapi.encoders import jsonable_encoder
from pydantic import BaseModel
from datetime import datetime
from datetime import timedelta
import plaid
import os
from datetime import datetime, date
import json
import time
from dotenv import load_dotenv

from .expense import create_expense
from .income import create_income
from ..models import AddExpense, User, AddIncome
from ..middleware import get_current_active_user
from ..database import user_collection

load_dotenv()

router = APIRouter()

# Fill in your Plaid API keys - https://dashboard.plaid.com/account/keys
PLAID_CLIENT_ID = os.getenv("PLAID_CLIENT_ID")
PLAID_SECRET = os.getenv("PLAID_SECRET")
# Use 'sandbox' to test with Plaid's Sandbox environment (username: user_good,
# password: pass_good)
# Use `development` to test with live users and credentials and `production`
# to go live
PLAID_ENV = os.getenv("PLAID_ENV", "sandbox")
# PLAID_PRODUCTS is a comma-separated list of products to use when initializing
# Link. Note that this list must contain 'assets' in order for the router to be
# able to create and retrieve asset reports.
PLAID_PRODUCTS = os.getenv("PLAID_PRODUCTS", "transactions").split(",")

# PLAID_COUNTRY_CODES is a comma-separated list of countries for which users
# will be able to select institutions from.
PLAID_COUNTRY_CODES = os.getenv("PLAID_COUNTRY_CODES", "US").split(",")


def empty_to_none(field):
    value = os.getenv(field)
    if value is None or len(value) == 0:
        return None
    return value


host = plaid.Environment.Sandbox

if PLAID_ENV == "sandbox":
    host = plaid.Environment.Sandbox

if PLAID_ENV == "development":
    host = plaid.Environment.Development

if PLAID_ENV == "production":
    host = plaid.Environment.Production

# Parameters used for the OAuth redirect Link flow.
#
# Set PLAID_REDIRECT_URI to 'http://localhost:3000/'
# The OAuth redirect flow requires an endpoint on the developer's website
# that the bank website should redirect to. You will need to configure
# this redirect URI for your client ID through the Plaid developer dashboard
# at https://dashboard.plaid.com/team/api.
PLAID_REDIRECT_URI = empty_to_none("PLAID_REDIRECT_URI")

configuration = plaid.Configuration(
    host=host,
    api_key={
        "clientId": PLAID_CLIENT_ID,
        "secret": PLAID_SECRET,
        "plaidVersion": "2020-09-14",
    },
)

api_client = plaid.ApiClient(configuration)
client = plaid_api.PlaidApi(api_client)

products = []
for product in PLAID_PRODUCTS:
    products.append(Products(product))

# We store the access_token in memory - in production, store it in a secure
# persistent data store.
access_token = None
# The payment_id is only relevant for the UK Payment Initiation product.
# We store the payment_id in memory - in production, store it in a secure
# persistent data store.
payment_id = None
# The transfer_id is only relevant for Transfer ACH product.
# We store the transfer_id in memomory - in produciton, store it in a secure
# persistent data store
transfer_id = None

item_id = None


@router.post("/api/info")
def info():
    global access_token
    global item_id
    return jsonable_encoder(
        {"item_id": item_id, "access_token": access_token, "products": PLAID_PRODUCTS}
    )


@router.post("/api/create_link_token")
def create_link_token():
    try:
        request = LinkTokenCreateRequest(
            products=products,
            client_name="Plaid Quickstart",
            country_codes=list(map(lambda x: CountryCode(x), PLAID_COUNTRY_CODES)),
            language="en",
            user=LinkTokenCreateRequestUser(client_user_id=str(time.time())),
        )

        # create link token
        response = client.link_token_create(request)
        return jsonable_encoder(response.to_dict())
    except ApiException as e:
        return json.loads(e.body)


# Exchange token flow - exchange a Link public_token for
# an API access_token
# https://plaid.com/docs/#exchange-token-flow


class PublicTokenBody(BaseModel):
    public_token: str


@router.get("/api/access_token")
def get_access_token(current_user: User = Depends(get_current_active_user)):
    if "plaid_access_token" in current_user:
        return {"access_token": current_user["plaid_access_token"]}
    return


@router.post("/api/set_access_token")
def get_access_token(body: PublicTokenBody):
    global access_token
    global item_id
    global transfer_id
    try:
        exchange_request = ItemPublicTokenExchangeRequest(
            public_token=body.public_token
        )
        exchange_response = client.item_public_token_exchange(exchange_request)
        access_token = exchange_response["access_token"]
        item_id = exchange_response["item_id"]
        if "transfer" in PLAID_PRODUCTS:
            transfer_id = authorize_and_create_transfer(access_token)
        return jsonable_encoder(exchange_response.to_dict())
    except ApiException as e:
        return json.loads(e.body)


# Retrieve Transactions for an Item
# https://plaid.com/docs/#transactions


@router.get("/api/transactions")
def get_transactions(
    access_token: str, current_user: User = Depends(get_current_active_user)
):
    start_date = (datetime.now() - timedelta(days=30)).date()
    if "plaid_last_fetch" in current_user:
        start_date = date.fromisoformat(current_user["plaid_last_fetch"])
    else:
        current_user["plaid_last_fetch"] = (
            (datetime.now() + timedelta(days=1)).date().isoformat()
        )

    if "plaid_access_token" in current_user:
        access_token = current_user["plaid_access_token"]
    else:
        current_user["plaid_access_token"] = access_token

    user_collection.update_one({"email": current_user["email"]}, {"$set": current_user})

    end_date = datetime.now().date()
    try:
        options = TransactionsGetRequestOptions()
        request = TransactionsGetRequest(
            access_token=access_token,
            start_date=start_date,
            end_date=end_date,
            options=options,
        )
        response = client.transactions_get(request)
        response = jsonable_encoder(response.to_dict())

        for transaction in response["transactions"]:
            try:
                if transaction["amount"] > 0:
                    create_expense(
                        AddExpense(
                            category="Other",
                            name=transaction["name"],
                            date=transaction["date"],
                            currency=transaction["iso_currency_code"],
                            price=transaction["amount"],
                        ),
                        current_user,
                    )
                else:
                    create_income(
                        AddIncome(
                            category="Other",
                            name=transaction["name"],
                            date=transaction["date"],
                            currency=transaction["iso_currency_code"],
                            amount=transaction["amount"] * -1,
                        ),
                        current_user,
                    )
            except:
                continue

        return response
    except ApiException as e:
        error_response = format_error(e)
        return jsonable_encoder(error_response)


def pretty_print_response(response):
    print(json.dumps(response, indent=2, sort_keys=True, default=str))


def format_error(e):
    response = json.loads(e.body)
    return {
        "error": {
            "status_code": e.status,
            "display_message": response["error_message"],
            "error_code": response["error_code"],
            "error_type": response["error_type"],
        }
    }


# This is a helper function to authorize and create a Transfer after successful
# exchange of a public_token for an access_token. The transfer_id is then used
# to obtain the data about that particular Transfer.
def authorize_and_create_transfer(access_token):
    try:
        # We call /accounts/get to obtain first account_id - in production,
        # account_id's should be persisted in a data store and retrieved
        # from there.
        request = AccountsGetRequest(access_token=access_token)
        response = client.accounts_get(request)
        account_id = response["accounts"][0]["account_id"]

        request = TransferAuthorizationCreateRequest(
            access_token=access_token,
            account_id=account_id,
            type=TransferType("credit"),
            network=TransferNetwork("ach"),
            amount="1.34",
            ach_class=ACHClass("ppd"),
            user=TransferUserInRequest(
                legal_name="FirstName LastName",
                email_address="foobar@email.com",
                address=TransferUserAddressInRequest(
                    street="123 Main St.",
                    city="San Francisco",
                    region="CA",
                    postal_code="94053",
                    country="US",
                ),
            ),
        )
        response = client.transfer_authorization_create(request)
        pretty_print_response(response)
        authorization_id = response["authorization"]["id"]

        request = TransferCreateRequest(
            idempotency_key=TransferCreateIdempotencyKey("1223abc456xyz7890001"),
            access_token=access_token,
            account_id=account_id,
            authorization_id=authorization_id,
            type=TransferType("credit"),
            network=TransferNetwork("ach"),
            amount="1.34",
            description="Payment",
            ach_class=ACHClass("ppd"),
            user=TransferUserInRequest(
                legal_name="FirstName LastName",
                email_address="foobar@email.com",
                address=TransferUserAddressInRequest(
                    street="123 Main St.",
                    city="San Francisco",
                    region="CA",
                    postal_code="94053",
                    country="US",
                ),
            ),
        )
        response = client.transfer_create(request)
        pretty_print_response(response)
        return response["transfer"]["id"]
    except ApiException as e:
        error_response = format_error(e)
        return jsonable_encoder(error_response)
